<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!-- favicon -  thanks to https://favicon.io/favicon-generator/ -->
		<link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
		<!-- JS and CSS -->
        <link rel="stylesheet" href="css/stylestests.css" />
		<!-- <script src="https://cdn.jsdelivr.net/npm/dropbox@10.34.0/dist/Dropbox-sdk.js"></script> -->

        <title>My three.js tests</title>
	</head>
	<body>
		<p><a href="index.html">Back home</a></p>
		<div id="three-container"></div>
		FOV: <input type="range" id="fov-slider" min="0" max="100" value="75" step="1">
		Camera X: <input type="range" id="camera-x-slider" min="-10" max="10" value="5" step="0.1" autocomplete="off">
		Camera Y: <input type="range" id="camera-y-slider" min="-10" max="10" value="5" step="0.1" autocomplete="off">
		Camera Z: <input type="range" id="camera-z-slider" min="-10" max="10" value="-10" step="0.1" autocomplete="off">
		<script type="module">

			import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js';
			import {GLTFLoader} from 'https://cdn.jsdelivr.net/npm/three@0.118.1/examples/jsm/loaders/GLTFLoader.js';
			import {OrbitControls} from 'https://cdn.jsdelivr.net/npm/three@0.118/examples/jsm/controls/OrbitControls.js';

			
			// Renderer
			const renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setSize( window.innerWidth*.8, window.innerHeight*.8 );
			renderer.physicallyCorrectLights = true;
			document.querySelector('#three-container').appendChild( renderer.domElement );

			// Scene
			const scene = new THREE.Scene();
			scene.background = new THREE.Color('skyblue');
			
			// Camera
			const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
			camera.position.x = document.querySelector('#camera-x-slider').value;
			camera.position.y = document.querySelector('#camera-y-slider').value;
			camera.position.z = document.querySelector('#camera-z-slider').value;
			// camera.lookAt(0,0,0);

			// Camera Helper (also create a second camera to see all the lines) - for some reason can't move the camera from 0,0,0
			// const camera2 = new THREE.PerspectiveCamera( 5, window.innerWidth / window.innerHeight, 5, 10 );
			// camera2.position.set(0,20,0);
			// const helper = new THREE.CameraHelper( camera2 );
			// scene.add( helper );

			// Geometry
			const geometry = new THREE.BoxGeometry( 1, 1, 1 );
			const material = new THREE.MeshStandardMaterial( { color: 0x00ff00 } );
			const cube = new THREE.Mesh( geometry, material );
			scene.add(cube);

			// Ground with helper grid - from https://threejs.org/examples/#webgl_animation_skinning_morph
			// const floor = new THREE.Mesh( new THREE.PlaneGeometry( 2000, 2000 ), new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false } ) );
			// floor.rotation.x = - Math.PI / 2;
			// scene.add( floor );
			// const grid = new THREE.GridHelper( 200, 40, 0x000000, 0x000000 );
			// grid.material.opacity = 0.2;
			// grid.material.transparent = true;
			// scene.add( grid );
			
			// Light
			const light = new THREE.DirectionalLight('white', 8);
  			light.position.set(10, 10, 0);
			scene.add(light);

			// AxesHelper
			const axesHelper = new THREE.AxesHelper( 100 );
			scene.add(axesHelper);

			// OrbitControls
			const controls = new OrbitControls( camera, renderer.domElement );
			controls.addEventListener('change', () => {
				// update sliders when the camera is moved with the mouse (OrbitControls)
				document.querySelector('#fov-slider').value = camera.fov;
				document.querySelector('#camera-x-slider').value = camera.position.x;
				document.querySelector('#camera-y-slider').value = camera.position.y;
				document.querySelector('#camera-z-slider').value = camera.position.z;
			});


			// GLTFLoader
			const loader = new GLTFLoader();
			let model;
			let mixer;
			let fileLocation = 'Windmill Course Animation.glb';

			// can also retrieve file from dropbox instead of locally:
			// let fileLocation = 'https://dl.dropboxusercontent.com/s/6lv8fc5a6hkpoj5/Windmill%20Course%20Animation.glb?dl=0';

			// or, as the above (using the URL dl.dropboxusercontent.com to bypass CORS) is not fully supported, we can also use the code below (inspired by https://github.com/dropbox/dropbox-sdk-js/blob/main/examples/javascript/download/index.html)
			// we need to generate the ACCESS_TOKEN from https://www.dropbox.com/developers/apps
			// THIS METHOD IS NOT SAFE FOR PRODUCTION - ACESS_TOKEN AND ACCESS TO MY DROPBOX SHOULD BE KEPT PRIVATE
			// let fileLocation = '';
			// var dbx = new Dropbox.Dropbox({ accessToken: "ACCESS_TOKEN" });
			// await dbx.sharingGetSharedLinkFile({url: "https://www.dropbox.com/s/6lv8fc5a6hkpoj5/Windmill%20Course%20Animation.glb?dl=0"})
			// 	.then(function(data) {
			// 		console.log(data);
			// 		fileLocation = URL.createObjectURL(data.result.fileBlob);
			// 	})

			const clock = new THREE.Clock(); // clock for animation
			loader.load( fileLocation, function ( gltf ) {
				console.log(gltf);
				model = gltf.scene;
				// add animations - view-source:https://threejs.org/examples/webgl_loader_fbx.html
				mixer = new THREE.AnimationMixer( gltf.scene );
				const action = mixer.clipAction( gltf.animations[ 0 ] );
				action.play();
				scene.add( gltf.scene );
			}, undefined, function ( error ) {
				console.error( error );
			} );
			

			function animate() {
				requestAnimationFrame( animate );

				cube.rotation.x += 0.01;
				cube.rotation.y += 0.01;
				// if(model) {
				// 	model.rotation.x += 0.01;
				// 	model.rotation.y += 0.01;
				// }

				const delta = clock.getDelta();
				if ( mixer ) mixer.update( delta );

				renderer.render( scene, camera );
			};

			animate();


			// resize scene on window resize - https://discoverthreejs.com/book/first-steps/responsive-design/
			window.addEventListener("resize", () => {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(window.innerWidth*.8, window.innerHeight*.8);
				renderer.setPixelRatio(window.devicePixelRatio);
			});
			
			// Sliders events
			document.querySelector('#fov-slider').addEventListener('input', function() {
				camera.fov = this.value;
				camera.updateProjectionMatrix();
				controls.update();
			});
			document.querySelector('#camera-x-slider').addEventListener('input', function() {
				camera.position.x = this.value;
				camera.updateProjectionMatrix();
				controls.update();
			});
			document.querySelector('#camera-y-slider').addEventListener('input', function() {
				camera.position.y = this.value;
				camera.updateProjectionMatrix();
				controls.update();
			});
			document.querySelector('#camera-z-slider').addEventListener('input', function() {
				camera.position.z = this.value;
				camera.updateProjectionMatrix();
				controls.update();
			});

		</script>
	</body>
</html>